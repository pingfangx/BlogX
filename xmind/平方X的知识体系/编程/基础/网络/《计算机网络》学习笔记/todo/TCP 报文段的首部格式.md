# 00 首部格式
     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          源端口(16)           |         目的端口(16)          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                            序号(32)                           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                           确认号(32)                          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    | 数据  |           |U|A|P|R|S|F|                               |
    |偏移(4)|  保留(6)  |R|C|S|S|Y|I|           窗口(16)            |
    |       |           |G|K|H|T|N|N|                               |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          检验和(16)           |         紧急指针(16)          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |               选项（长度可变）                |      填充     |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                             数据                              |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


    源端口(16)                                                         目的端口(16)
                                    序号(32)
                                   确认号(32)
    数据偏移(4)      保留(6)     URG ACK PSH RST SYN FIN               窗口(16)
    检验和(16)                                                         紧急指针(16)
    选项（长度可变）                                    填充
                                    数据

说明    
* 示例每行共 32 位，表示 4 字节
* 前 5 行固定， 即 5*4=20 字节是固定的，也就是说 TCP 首部最小长度是 20 字节
* 受 4 位的数据偏移限制，最大可表示 2^4-1=15 单位为 32 位字，即 4 字节  
也就是说 TCP 首部最大长度为 60 字节（即选项长度最长 40 字节）
* 每行表示 4 字节，最后一部分选项，要加上填充，填充到 4n 字节（根据前述 n 最大为 10）  
填充的目的是用于计算检验和

# (1)源端口和目的端口
* 各占 2 字节，16 位
## 可表示端口范围
2^16-1=65535

所以端口范围为 0-65535  
具体端口还有不同的范围分类，可查看《端口是什么》及 wiki

## 为什么没有 IP 地址，只有端口
TCP 属于运输层，网络层的 IP 协议的 IP 数据报的首部才添加 IP 地址  
但在计算检验和时添加的伪首部（后文介绍）中包含 IP 地址  
IP 地址需要 4 字节 32 位，每字节最大可表示 2^8-1=255  


# (2)序号
在《TCP 报文段序号》中有更多讨论

* 4 字节，32 位。最大可表示 2^32-1，增加到最大序号后，下一个序号为 0
* 连接建立和断开时的交换的部分报文段也消耗序号（后文介绍）
* 在一个 TCP 连接中传送的字节流的每一个字节都按顺序编号
* 整个要传送的字节流的起始序号必须在连接建立时设置
* 首部中的序号字段值指的是本报文段所发送的数据的第一个字节的序号（每个报文段可传送多个字节）  

# (3)确认号
* 4 字节，与序号相同
* 表示期待收到对方下一个报文段的第一个数据字节的序号（也就是说表示确认收到的最后一个序号+1）
* 连接的建立和断开也用到确认号

# (4)数据偏移
* 4 位，表示的单位为 32 位（即 4 字节）  
最大可表示 2^4-1=15 个 32 位，即 60 字节
* 表示 TCP 报文段的数据起始处距 TCP 报文段的起始处的距离  
（也就是表示 TCP 报文段首部的长度）

# (5)保留
* 6 位
* 结合前面的 4 位数据偏移，后续的 6 位，共 4+6+6 = 16 位

# (6)紧急 URG(URGent)
* 紧急数据在本报文段数据的最前面，紧急数据后面的数据仍是普通数据，配合紧急指针字段使用

# (7)确认 ACK(ACknowledgement)
* 仅当 ACK=1 时确认号字段有效
* TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1

# (8)推送 PSH(PuSH)
* 用于告之接收方尽快将数据交付接收应用程序，而不再等到整个缓存填满才向上交付

# (9)复位 RST(ReSeT)
* RST=1 表示 TCP 连接中出现严复错误，必须释放连接，再重新建立运输连接
* RST 置 1 还用来拒绝一个非法的报文段或拒绝打开一个连接

# (10)同步 SYN(SYNchronization)
* 用于连接的建立与释放

# (11)终止 FIN(FINish)
* 用于断开连接

# (12)窗口
窗口在书中后续的滑动窗口有更多介绍
* 16 位，2 字节
* 指的是发送本报文段的一方的接收窗口（而不是自己的发送窗口）
* 窗口值作为接收方让发送方设置其发送窗口的依据
* 窗口字段明确指出现在允许对方发送的数据量，窗口值在动态变化

# (13)检验和
在《检验和及反码求和》中有更多讨论
* 2 字节
* 计算检验和需要加上 12 字节的伪首部

# (14)紧急指针
* 2 字节
* 配合 URG=1 使用
* 即使窗口为零也可发送紧急数据

# (15)选项
* 最长 40 字节（根据之前的数据偏移限制）
* MSS 最大报文段长度选项
* 窗口扩大选项
* 时间戳选项